<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective notebook</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <h1>Detective Notebook</h1><input type="button" id="plus" value="+ New known card" onclick="newCards()">

    </div>
    <div id="Settings" class="settings">
        <!-- Div containing all settings (enter player names, how many cards, names of cards ...) -->
        <p>Players in order, starting with yourself (comma-separated):</p>
        <input style="width: 90%;" placeholder="Player names" id="inNames"><br>
        <p>Each player has <input type="number" min="1" max="30" id="inNCards"> cards</p><br>
        <input type="button" value="Confirm!" class="confirm" onclick="confirmSettings()">
    </div>

    <div id="Cards" class="cards hidden">
        <h1>Cards</h1>
        <div id="Guests">
            <h2>Guest</h2>
            <input type="button" value="placeholder" id="buttonCardPlaceholder" onclick="this.classList.toggle('selected')"
            style="display: none;">
        </div>
        <div id="Weapons">
            <h2>Weapon</h2>
        </div>
        <div id="Rooms">
            <h2>Room</h2>
        </div>
    </div>

    <div id="Users" class="users hidden">
        <h1>Users</h1>
    </div>

    <div id="YourCards" class="settings hidden">
        <h1>Your cards</h1>
        <p>Select the cards you have in hands.</p>
        <!-- Cards here -->
        <input type="button" value="Confirm!" id="YourCardsConfirm" onclick="confirmYourCards()">
    </div>

    <div id="NewKnownCard" class="hidden">
        <h1>New known card</h1>
        <p>Select the player whose card you newly know</p>
        <!-- Users here -->
        <p id="NewKnownCardsText">Select new known cards</p>
        <input type="button" value="Confirm!" id="NewKnownCardConfirm" onclick="confirmNewCards()">
    </div>

    <div id="Turn" class="turn hidden">
        <h1 id="who">Someone's turn</h1>
        <p>Select the cards that were called</p>
        <!-- Cards here -->
        <p id="TurnUserText">Select the first user that showed a card</p>
        <!-- Users here -->
        <input type="button" value="Confirm!" id="TurnUserTextConfirm" onclick="confirmNewTurn()">
    </div>

    <div id="Notebook" class="notebook ">
        <h1>Notebook grid</h1>
        <table>
            <thead id="NoteHead">
                <tr id="tableRowPlaceholder"><th id="tableHeaderPlaceholder">Card / User</th></tr>
            </thead>
            <tbody id="NoteTable">
            </tbody>
        </table>
    </div>

    <div id="Helper" class="helper ">
        <h1>Helper info</h1>
        <p id="HelperText"></p>
    </div>





    <script src="script.js"></script>
    <script> /* CARDS BUTTON GENERATOR */
        // Must be after loading script.js because it uses card arrays from there
        const buttonCardPlaceholder = document.getElementById("buttonCardPlaceholder");
        const tableRowPlaceholder = document.getElementById("tableRowPlaceholder");
        const NoteTable = document.getElementById("NoteTable");
        const NoteHead = document.getElementById("NoteHead");
        const tableHeaderPlaceholder = document.getElementById("tableHeaderPlaceholder");
        const NoteTableHeader = document.getElementById("NoteTableHeader");
        let tdPlaceholder = document.createElement("td");
        
        function generateCardsUsers() {
            for(let g of guests) {
                let gb = buttonCardPlaceholder.cloneNode();
                gb.style.display = "inline-block";
                gb.id = gb.value = g;
                document.getElementById("Guests").appendChild(gb);

                let tr = tableRowPlaceholder.cloneNode();
                tr.attributes.removeNamedItem("id");
                tr.dataset.card = g;
                let td = tdPlaceholder.cloneNode();
                td.innerText = g;
                tr.appendChild(td);
                NoteTable.appendChild(tr);
            }
            // Add a table divider
            NoteTable.lastElementChild.classList.add("border_bottom");
            
            for(let w of weapons) {
                let wb = buttonCardPlaceholder.cloneNode();
                wb.style.display = "inline-block";
                wb.id = wb.value = w;
                document.getElementById("Weapons").appendChild(wb);

                let tr = tableRowPlaceholder.cloneNode();
                tr.attributes.removeNamedItem("id");
                tr.dataset.card = w;
                let td = tdPlaceholder.cloneNode();
                td.innerText = w;
                tr.appendChild(td);
                NoteTable.appendChild(tr);
            }
            // Add a table divider
            NoteTable.lastElementChild.classList.add("border_bottom");

            
            for(let r of rooms) {
                let rb = buttonCardPlaceholder.cloneNode();
                rb.style.display = "inline-block";
                rb.id = rb.value = r;
                document.getElementById("Rooms").appendChild(rb);

                let tr = tableRowPlaceholder.cloneNode();
                tr.attributes.removeNamedItem("id");
                tr.dataset.card = r;
                let td = tdPlaceholder.cloneNode();
                td.innerText = r;
                tr.appendChild(td);
                NoteTable.appendChild(tr);
            }
            // Add a table divider
            NoteTable.lastElementChild.classList.add("border_bottom");

            for(let [n, d] of players) {
                let nb = buttonCardPlaceholder.cloneNode();
                nb.style.display = "inline-block";
                nb.dataset.player = nb.value = n;
                nb.attributes.removeNamedItem("id"); // We don't need IDs as we have data-player
                                // TODO: Maybe we should move IDs to data-card with cards as well.
                document.getElementById("Users").appendChild(nb);

                let th = tableHeaderPlaceholder.cloneNode();
                th.attributes.removeNamedItem("id");
                th.innerText = n;
                tableRowPlaceholder.appendChild(th);
            }
        }
    </script>
    <script> /* GUIDE THROUGH STEPS */
        var SettingsL = document.getElementById("Settings");
        var CardsL = document.getElementById("Cards");
        var YourCardsL = document.getElementById("YourCards");
        var UsersL = document.getElementById("Users");
        var NewKnownCardL = document.getElementById("NewKnownCard");
        var TurnL = document.getElementById("Turn");
        var whoT = document.getElementById("who");
        var HelperText = document.getElementById("HelperText");
        // Show settings

        SettingsL.classList.remove("hidden");
        /*let next = Settings.getElementsByClassName("confirm")[0].addEventListener("click", (e) => {
                        
        })*/

        function clearSelection() {
            // HTMLcollection needs to be spread into an array
            // or else it shrinks while removing the selected class
            for(let s of [...document.getElementsByClassName("selected")]) {
                s.classList.remove("selected");
            }
            updateTable();
        }

        function confirmSettings() {
            init(
                document.getElementById("inNames").value, 
                document.getElementById("inNCards").value)
            SettingsL.classList.add("hidden");
            generateCardsUsers();
            yourCards();
        }

        function yourCards() {
            YourCardsL.append(CardsL, document.getElementById("YourCardsConfirm"));
            YourCardsL.classList.remove("hidden");
            CardsL.classList.remove("hidden");
        }

        function confirmYourCards() {
            for(let {id} of CardsL.getElementsByClassName("selected")) {
                //console.log(id);
                knownCard(currentPlayer, id);
            }
            clearSelection();
            YourCardsL.classList.add("hidden");
            document.getElementById("plus").classList.remove("hidden");
            newTurn();
        }

        function newCards() {
            TurnL.classList.add("hidden");
            NewKnownCardL.append(UsersL, document.getElementById("NewKnownCardsText"), CardsL, document.getElementById("NewKnownCardConfirm"));
            NewKnownCardL.classList.remove("hidden");
            CardsL.classList.remove("hidden");
            UsersL.classList.remove("hidden");
        }

        function confirmNewCards() {
            let user = UsersL.getElementsByClassName("selected")[0]?.dataset.player;
            if(UsersL.getElementsByClassName("selected").length != 1) alert("You have messed up the whole thing 😔\nOnly one user should have been selected ...");
            for(let {id} of CardsL.getElementsByClassName("selected")) {
                //console.log(id);
                knownCard(user, id);
            }
            clearSelection();
            NewKnownCardL.classList.add("hidden");
            newTurn();
        }

        function newTurn() {
            whoT.innerText = `${currentPlayer}'s turn`;
            TurnL.append(CardsL, document.getElementById("TurnUserText"), UsersL, document.getElementById("TurnUserTextConfirm"));
            TurnL.classList.remove("hidden");
            CardsL.classList.remove("hidden");
            UsersL.classList.remove("hidden");
        }

        function confirmNewTurn() {
            let witness = UsersL.getElementsByClassName("selected")[0]?.dataset.player; // Who showed a card
            if(UsersL.getElementsByClassName("selected").length > 1) alert("You have messed up the whole thing 😔\nOnly one user should have been selected ...");
            let called = [];
            for(let {id} of CardsL.getElementsByClassName("selected")) {
                //console.log(id);
                called.push(id);
            }

            let showerGen = order();
            showerGen.next(); // Yield input value is ignored the first time
            let shower = showerGen.next(currentIndex).value; // Just goes around until it reaches the one you selected
            console.warn("THIS");
            for(let i = 1; i < NPlayers; i++) {
                //console.log(shower, witness);
                console.assert(shower != currentPlayer, "Loops too many times! It should exit _before_ coming around");
                if(shower == witness) {
                    holdsCards(shower, called, true);
                    break;
                } else {
                    holdsCards(shower, called, false);
                    shower = showerGen.next().value;
                }
            }
            writeRound(new Round(currentPlayer, called, witness));
            clearSelection();

            nextRound();
            newTurn();
        }

        function updateTable() {
            for(let u of [...NoteTable.getElementsByClassName("updatable")]) {
                u.remove();
            }
            let rows = NoteTable.getElementsByTagName("tr");
            for(let [n, p] of players) {
                for(row of rows) {
                    let lacking = p.lacks[row.dataset.card];
                    //console.log(n, lacking);
                    let td = tdPlaceholder.cloneNode();
                    td.classList.add("updatable"); // so that we know which elements to delete and re-create on update
                    td.classList.add("center")
                    if(lacking === true) {
                        td.innerText = "❌";
                    } else if(lacking === false) {
                        td.innerText = "✔";
                    } else if(lacking === undefined) {
                        // nothing to do, for now
                    }
                    row.appendChild(td);
                }
            }

            // We'll also update our helper here
            HelperText.innerText = [...helper].join("\n");
        }

    </script>
</body>
</html>